**Необходимо написать к каким системам по CAP теореме относятся перечисленные БД и почему: MongoDB, MSSQL, Cassandra.**


Существуют три базовые концепции, между которымии приходится балансировать, чтобы выбрать правильную БД.

**_Consistency ( C )_** -  ­ если ты пишешь данные в систему, ты всегда прочитаешь эти данные в любой момент времени, с любого узла системы (если данные неконсиситентны, то система вернет ошибку, но не некорректные данные). Consistency в распределенной системе должна обеспечиваться на всех нодах кластера, а не на одной серверной ноде (на одной - это ACID).

**_Availability ( A )_** -­ распределенная система должна обеспечивать чтение/запись с любой “живой” ноды (которая сейчас пингуется клиентом), нода должна откликнуться реальными данными, а не сообщением о полной недоступности системы. Рассматривается поведение кластера нод при частичной недоступности сети: весь ли он упадет либо продолжит отвечать на запросы.

**_Partition  Tolerance  ( P )_** ­- если возникнет ситуация, в которой ноды в распределенной системе не видят друг друга, то система всё равно должна функционироавть.

В распределенной системе мы ожидаем, что _( P )_ будет всегда соблюдена, так как это суть распределенной системы. По CAP-теореме достичь одновременно соблюдения _( A )_ и _( C )_ не удастся, поэтому придется выбрать что важнее при построении архитектуры: уйти в _AP_ или _CP_.

## MongoDB

![MongoDB replication](https://www.mongodb.com/docs/manual/images/replica-set-primary-with-two-secondaries.bakedsvg.svg)

MongoDB  является распределенной системой с одним master-узлом и несколькими slave-репликами, которые обновляют свои данные асинхронно. Каждый узел способен пинговать ситуацию, что ведущий узел не упал. Если же лидер выйдет из строя, то реплики выберут нового.

![MongoDB replication + client](https://www.mongodb.com/docs/manual/images/replica-set-read-write-operations-primary.bakedsvg.svg)

По умолчанию клиент будет читать/писать через ведущий узел. Следовательно, _Consistency_ данных должна выполниться, так как клиенты обращаются всё время к одному узлу.

_Partition  Tolerance_  также должна выполниться, так как узлы при потери связи между собой остаются функционирующими и начинают искать нового лидера.

С _Availability_  будут проблемы: если клиент читает/пишет на лидера, и он упадет, то доступность просядет пока не выберут нового лидера и на него перекинут клиентские чтение/запись.

Таким образом можно отнести MongoDB  к классу **CP-систем**.

>Можно включить у MongoDB  возможность читать клиенту со slave-реплики, но тем самым мы поступимся консистентностью данных (запись на лидера прошла, а до реплики данные не дошли из-за обрыва связи между узлами). И в итоге с такими настройками Mongo  начнет перемещаться к классу AP-систем.
>
>Можно добавить настройку с указанием количества нод, которые должны подтвердить факт записи, прежде чем клиенту вернется сообщение об успешном прохождении записи, тем самым повысим консистентность данных. Но если даже с такой настройкой лидер падает, то запись не будет подтверждена клиенту до тех пор, пока не пройдут выборы нового лидера, поэтому об Availability  на запись нельзя говорить. И мы опять возвращаемся к CP-классу систем.

## MSSQL
Первоначально MSSQL  как RDBMS-система, состоящая из одного узла, не испытывает проблем с _Partition  Tolerance_ (узел один), следовательно должна рассматриваться как **CA-система** (ACID  обеспечит ей _Consistency_, а всегда запущенный сервер стабильно даст ответ _Availability_).

>Чтобы рассмотреть MSSQL  в формате распределенной системы, мы должны настроить её репликацию.
>
>При репликации _Consistency_  можно обеспечить, если чтение/запись клиент будет осуществлять с publisher-ноды.
Если клиенты могут читать/писать на разных инстансах, то в какой-то момент Consistency  будет нарушена при неожиданном обрыве сети.
>
>Есть еще настройка `Always  On`, которая должна решить проблему высокой доступности за счет появления балансировщика. Но все отклонения в сторону улучшения _Partition  Tolerance_  сказываются на ухудшении _( C )_ или _( A )_

Получается, что распределенную систему CA-класса не удается построить в терминах CAP-теоремы. Но один узел MSSQL  можно считать CA-системой (у одного узла неконсистентности быть не может и она доступна всегда, пока доступен её один узел).

## Cassandra
![Cassamdra replication](https://i0.wp.com/proselyte.net/wp-content/uploads/2019/07/replication-and-consistency-in-cassandra.jpg)

Базовые настройки Cassandra  предполагают, что любая нода может быть использована для чтения/записи. Если одна нода падает, то другие подхватят её функции. С помощью `Replication Factor` мы определим скольким нодам она будет регулярно поставлять обновления. Получается _Availability_ системы крайне высокая и при частичном отключении сети между нодами клиент не пострадает (так как в отличие от MongoDB  она не имеет master-ноды).

Система не обеспечивает консистентность данных между узлами в базовых настройках (`Consistency Level = ONE`): записав на одну ноду, нет гарантий что данные дойдут до своих реплик.

Таким образом её можно отнести к классу **AP-систем**.

>Но если настройками увеличить `Consistency  Level`  (например, до 3), Cassandra  прочитает с трех реплик, самые свежие данные примет за правильные, на репликах с несвежими данными должна произвести запись до актуального состояния. И если при такой настройке `Consistency  Level = THREE` одна из нод упадет, то чтение/запись станут недоступными, а следовательно, не обеспечивается _Availability_  и Cassandra  сместится к классу CP-систем.
